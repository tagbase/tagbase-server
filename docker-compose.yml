version: '3.9'
services:
  dbbackups:
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - DUMPPREFIX=PG_db
      - POSTGRES_USER=tagbase
      - POSTGRES_PASS=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_HOST=postgis
    hostname: pg-backups
    image: kartoza/pg-backup:14-3.3
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "Docker PostGIS backup"
      "docker_compose_diagram.icon": "docker"
    links:
      - postgis
    networks:
      - internal-network
    restart: unless-stopped
    volumes:
      - ./dbbackups:/backups
  docker-cron:
    build:
      context: ./services/docker-cron
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "'metadata_types' and\n'observation_types' synchronization"
      "docker_compose_diagram.icon": "python"
    links:
      - postgis
    networks:
      - internal-network
    restart: unless-stopped
  nginx:
    build:
      context: ./services/nginx
    labels:
      #"docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "Reverse proxy \n and authentication."
      "docker_compose_diagram.icon": "nginx"
    links:
     - pgadmin4
     - tagbase_server
    networks:
      - internal-network
    ports:
      - 81:81
      - 443:443
    volumes:
      - ./services/nginx/config/nginx.conf:/etc/nginx/nginx.conf
      - ./services/nginx/proxy/:/usr/share/nginx/html/:ro
      - ./services/nginx/ssl/cert.pem:/etc/nginx/certs/cert.pem
      - ./services/nginx/ssl/key.pem:/etc/nginx/certs/key.pem
  pgadmin4:
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
      - PGADMIN_LISTEN_PORT=5434
    expose:
      - 5434
    hostname: pgadmin4
    image: dpage/pgadmin4:latest
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "PostgreSQL administration"
      "docker_compose_diagram.icon": "docker"
    links:
      - postgis
    networks:
      - internal-network
    restart: unless-stopped
  postgis:
    environment:
      - ALLOW_IP_RANGE=0.0.0.0/0
      - EXTRA_CONF=log_destination = stderr\nlogging_collector = on
      - PASSWORD_AUTHENTICATION=md5
      #- POSTGRES_DB=tagbase
      - POSTGRES_PASS=${POSTGRES_PASSWORD}
      - POSTGRES_USER=tagbase
      - POSTGRES_MULTIPLE_EXTENSIONS=postgis,hstore,postgis_topology,postgis_raster,pgrouting
    expose:
      - ${POSTGRES_PORT}
    healthcheck:
      test: "PGPASSWORD=${POSTGRES_PASSWORD} pg_isready -d tagbase -h postgis -U tagbase"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    hostname: postgis
    image: kartoza/postgis:15-3.3
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "Tagbase PostGIS server"
    networks:
      - internal-network
    ports:
      - "5432:5432"
    restart: unless-stopped
    volumes:
      - ./dbbackups:/backups
      - ./postgis-data:/var/lib/postgresql
      - ./services/postgis/tagbase_schema.sql:/docker-entrypoint-initdb.d/tagbase_schema.sql
  rabbitmq:
    depends_on:
      postgis:
        condition: service_healthy
    healthcheck:
      test: "set -eo pipefail rabbitmqctl eval '{ true, rabbit_app_booted_and_running } = { rabbit:is_booted(node()), rabbit_app_booted_and_running }, { [], no_alarms } = { rabbit:alarms(), no_alarms }, [] /= rabbit_networking:active_listeners(), rabbitmq_node_is_healthy.' || exit 1"
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    hostname: rabbitmq
    image: rabbitmq:3-management-alpine
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "rabbitmq messaging service"
      "docker_compose_diagram.icon": "rabbitmq"
    networks:
      - internal-network
    ports:
      - 5672:5672
      - 15672:15672
    restart: unless-stopped
    volumes:
      - ./rabbitmq/data/:/var/lib/rabbitmq/
      - ./logs/rabbitmq/:/var/log/rabbitmq/
  rabbitmq_subscriber:
    build:
      context: ./services/subscriber
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
    hostname: rabbitmq_subscriber
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "rabbitmq subscriber service"
      "docker_compose_diagram.icon": "rabbitmq"
    links:
      - postgis
      - rabbitmq
    networks:
      - internal-network
    restart: unless-stopped
    volumes:
      - ./logs/rabbitmq_subscriber:/usr/src/app/logs/rabbitmq_subscriber
  slack_docker:
    environment:
      - webhook=${webhook}
    image: ghcr.io/int128/slack-docker
    labels:
      #"docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "Docker events management"
      "docker_compose_diagram.icon": "docker"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
  tagbase_server:
    build:
      context: ./tagbase_server
    depends_on:
      postgis:
        condition: service_healthy
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - SLACK_BOT_CHANNEL=${SLACK_BOT_CHANNEL}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
    expose:
      - 5433
    hostname: tagbase_server
    labels:
      "docker_compose_diagram.cluster": "Internal Network"
      "docker_compose_diagram.description": "tagbase-server tag \ningestion and administration"
      "docker_compose_diagram.icon": "flask"
    links:
      - postgis
      - rabbitmq
    networks:
      - internal-network
    restart: unless-stopped
    volumes:
      - ./logs/tagbase_server:/usr/src/app/logs/tagbase_server
networks:
  internal-network: